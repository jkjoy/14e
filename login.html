<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .post-card { margin-bottom: 20px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">文章管理系统</h1>

        <!-- 用户认证部分 -->
        <div class="row">
            <div class="col-md-6">
                <h3>注册</h3>
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="registerPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">注册</button>
                </form>
                <div id="registerMessage" class="mt-2"></div>
            </div>
            <div class="col-md-6">
                <h3>登录</h3>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">邮箱</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">登录</button>
                    <button type="button" class="btn btn-secondary ms-2" id="logoutBtn" style="display: none;">登出</button>
                </form>
                <div id="loginMessage" class="mt-2"></div>
            </div>
        </div>

        <!-- 文章创建部分 -->
        <div class="my-4" id="postFormSection" style="display: none;">
            <h3>创建文章</h3>
            <form id="postForm">
                <div class="mb-3">
                    <label for="postTitle" class="form-label">标题</label>
                    <input type="text" class="form-control" id="postTitle" required>
                </div>
                <div class="mb-3">
                    <label for="postContent" class="form-label">内容 (Markdown)</label>
                    <textarea class="form-control" id="postContent" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发布文章</button>
            </form>
            <div id="postMessage" class="mt-2"></div>
        </div>

        <!-- 文件上传部分 -->
        <div class="my-4" id="uploadFormSection" style="display: none;">
            <h3>上传文件</h3>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="fileInput" class="form-label">选择文件</label>
                    <input type="file" class="form-control" id="fileInput" required>
                </div>
                <button type="submit" class="btn btn-primary">上传</button>
            </form>
            <div id="uploadMessage" class="mt-2"></div>
        </div>

        <!-- 文章列表部分 -->
        <div class="my-4">
            <h3>文章列表</h3>
            <div id="postList"></div>
            <nav aria-label="Page navigation">
                <ul class="pagination" id="pagination"></ul>
            </nav>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://weibo-backend.imsun.workers.dev/';
        let token = localStorage.getItem('token') || null;
        let currentPage = 1;
        const limit = 20;

        // 检查登录状态
        function checkAuthStatus() {
            if (token) {
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('postFormSection').style.display = 'block';
                document.getElementById('uploadFormSection').style.display = 'block';
            } else {
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('postFormSection').style.display = 'none';
                document.getElementById('uploadFormSection').style.display = 'none';
            }
        }

        // 显示消息
        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `mt-2 ${isError ? 'error' : 'success'}`;
        }

        // 注册
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const result = await response.json();
                if (result.success) {
                    token = result.data.token;
                    localStorage.setItem('token', token);
                    checkAuthStatus();
                    showMessage('registerMessage', result.message);
                } else {
                    showMessage('registerMessage', result.message, true);
                }
            } catch (error) {
                showMessage('registerMessage', '注册失败', true);
            }
        });

        // 登录
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const result = await response.json();
                if (result.success) {
                    token = result.data.token;
                    localStorage.setItem('token', token);
                    checkAuthStatus();
                    showMessage('loginMessage', '登录成功');
                    fetchPosts();
                } else {
                    showMessage('loginMessage', result.message, true);
                }
            } catch (error) {
                showMessage('loginMessage', '登录失败', true);
            }
        });

        // 登出
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${BASE_URL}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                token = null;
                localStorage.removeItem('token');
                checkAuthStatus();
                showMessage('loginMessage', '登出成功');
                fetchPosts();
            } catch (error) {
                showMessage('loginMessage', '登出失败', true);
            }
        });

        // 创建文章
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;

            try {
                const response = await fetch(`${BASE_URL}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ title, content })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('postMessage', '文章创建成功');
                    fetchPosts();
                    document.getElementById('postForm').reset();
                } else {
                    showMessage('postMessage', result.message, true);
                }
            } catch (error) {
                showMessage('postMessage', '文章创建失败', true);
            }
        });

        // 上传文件
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${BASE_URL}/api/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('uploadMessage', '文件上传成功');
                    fileInput.value = '';
                } else {
                    showMessage('uploadMessage', result.message, true);
                }
            } catch (error) {
                showMessage('uploadMessage', '文件上传失败', true);
            }
        });

        // 获取文章列表
        async function fetchPosts(page = 1) {
            currentPage = page;
            try {
                const response = await fetch(`${BASE_URL}/api/posts?page=${page}&limit=${limit}`);
                const result = await response.json();
                if (result.success) {
                    renderPosts(result.data.posts);
                    renderPagination(result.data.pagination);
                } else {
                    showMessage('postList', result.message, true);
                }
            } catch (error) {
                showMessage('postList', '获取文章失败', true);
            }
        }

        // 渲染文章列表
        function renderPosts(posts) {
            const postList = document.getElementById('postList');
            postList.innerHTML = '';
            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'card post-card';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${post.title}</h5>
                        <p class="card-text">${post.content.substring(0, 200)}...</p>
                        <p class="card-text"><small class="text-muted">作者: ${post.author_email} | 发布时间: ${new Date(post.created_at).toLocaleString()}</small></p>
                    </div>
                `;
                postList.appendChild(card);
            });
        }

        // 渲染分页
        function renderPagination(pagination) {
            const paginationUl = document.getElementById('pagination');
            paginationUl.innerHTML = '';
            if (pagination.totalPages <= 1) return;

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!pagination.hasPrev ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="fetchPosts(${pagination.page - 1})">上一页</a>`;
            paginationUl.appendChild(prevLi);

            for (let i = 1; i <= pagination.totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="fetchPosts(${i})">${i}</a>`;
                paginationUl.appendChild(li);
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!pagination.hasNext ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="fetchPosts(${pagination.page + 1})">下一页</a>`;
            paginationUl.appendChild(nextLi);
        }

        // 初始化
        checkAuthStatus();
        fetchPosts();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
